---
title: "p8105_hw2_th3147"
author: "Te-Hsuan Huang"
date: "2025-09-27"
output: github_document
---

# Problem 1

1. First dataset

```{r message = FALSE}
library(tidyverse)

polsmonth_df = read_csv(file = "./fivethirtyeight_datasets/pols-month.csv") |> 
  janitor::clean_names() |> 
  separate(mon, into = c("year", "month", "day"), sep = "-") |> 
 mutate( 
   year = as.numeric(year),
    month = case_match(
      month,
      "01" ~ "jan",
      "02" ~ "feb",
      "03" ~ "mar",
      "04" ~ "apr",
      "05" ~ "may",
      "06" ~ "jun",
      "07" ~ "jul",
      "08" ~ "aug",
      "09" ~ "sep",
      "10" ~ "oct",
      "11" ~ "nov",
      "12" ~ "dec"
    ), 
    president = case_match(
      prez_dem,
      1 ~ "dem",
      0 ~ "gop")) |> 
    select(-prez_dem, -prez_gop, -day)

polsmonth_df
  
```

* Note:

  * make sure the lower case in month.

2. second dataset

```{r message = FALSE}
snp_df = read_csv(file = "./fivethirtyeight_datasets/snp.csv") |> 
  janitor::clean_names() |> 
  separate(date, into = c("month", "day", "year"), sep = "/") |>
  mutate(
    year = as.integer(paste0("20", year)),
    year = as.numeric(year),
    month = case_match(
      month,
      "1" ~ "jan",
      "2" ~ "feb",
      "3" ~ "mar",
      "4" ~ "apr",
      "5" ~ "may",
      "6" ~ "jun",
      "7" ~ "jul",
      "8" ~ "aug",
      "9" ~ "sep",
      "10" ~ "oct",
      "11" ~ "nov",
      "12" ~ "dec"
    )) |> 
      select(-day) |>
      arrange (year, month) |> 
      relocate(year, month)

snp_df
```

* Note:

  * paste0: is a function in R used to concatenate (join together) character strings.

  * make sure the lower case in month.


3. Third dataset

```{r message = FALSE}
unemploy_df = read_csv(file = "./fivethirtyeight_datasets/unemployment.csv") |> 
  janitor::clean_names() |> 
  pivot_longer(
    jan:dec,
    names_to = "month", 
    values_to = "unemployment_rate") |> 
  relocate(year, month) |>
  arrange(year, month)

unemploy_df
```

4. Merge the dataset

```{r message = FALSE}
final_merged_df = 
   polsmonth_df |>
  left_join(snp_df, by = c("year", "month")) |>
  left_join(unemploy_df, by = c("year", "month"))

final_merged_df
```

* Note: 

  * the features of year and month in each dataset should be same.

  * the alphabet should be exactly same in month.

* The resulting dataset is a time-series data frame created by merging three original sources: pols-month.csv, which contains U.S. political control data (including the number of Democratic and Republican governors and the party of the sitting President); snp.csv, which tracks the S&P 500 closing price; and unemployment.csv, which records the national unemployment rate. After joining the three files on the common keys of year and month, the final merged dataset contains `r nrow(final_merged_df)` rows and `r ncol(final_merged_df)` columns, covering the time span from 1947 to 2015. Key variables include the date identifiers (year, month), political metrics (gov_gop, rep_dem, president), the financial index (close), and the economic indicator (unemployment_rate).


# Problem 2

1. First dataset

```{r message = FALSE}
mrtrash_df = 
  readxl::read_excel("./problem 2/202509 Trash Wheel Collection Data.xlsx"
                     , sheet="Mr. Trash Wheel"
                     , range = "A2:N709") |> 
  janitor::clean_names() |> 
   mutate(
    sports_balls = as.integer(round(as.numeric(`sports_balls`))),
    wheel_name = "Mr. Trash Wheel",
    year=as.numeric(year)
  ) |> 
  select(-dumpster) |> 
  relocate(year, month, wheel_name) |> 
  arrange(date)

mrtrash_df
```

2. Second dataset

```{r message = FALSE}
prtrash_df = 
  readxl::read_excel("./problem 2/202509 Trash Wheel Collection Data.xlsx"
                     , sheet="Professor Trash Wheel"
                     , range = "A2:M134") |> 
  janitor::clean_names() |> 
  mutate(
    wheel_name = "Professor Trash Wheel") |> 
  select(-dumpster) |> 
  relocate(year, month, wheel_name) |> 
  arrange(date)

prtrash_df
```

3. Third dataset

```{r message = FALSE}
gwtrash_df = 
  readxl::read_excel("./problem 2/202509 Trash Wheel Collection Data.xlsx"
                     , sheet="Gwynns Falls Trash Wheel"
                     , range = "A2:L351") |> 
  janitor::clean_names() |> 
  mutate(
    wheel_name = "Gwynns Falls Trash Wheel") |> 
  select(-dumpster) |> 
  relocate(year, month, wheel_name) |> 
  arrange(date)
  
gwtrash_df
```

4. Combine the dataset

```{r message = FALSE}
final_merged2_df = 
  bind_rows(mrtrash_df, prtrash_df, gwtrash_df) |>
  janitor::clean_names()

final_merged2_df
```

* The combined Trash Wheel dataset is a time-series data frame that aggregates collection metrics for three different wheels: Mr. Trash Wheel, Professor Trash Wheel, and Gwynnda. This dataset contains `r nrow(final_merged2_df)` observations, with key variables including the wheel identifier, the date, the amount of trash collected by weight, and specific item counts like plastic_bottles and cigarette_butts. Analysis of the individual wheels shows that the total weight of trash collected by Professor Trash Wheel amounts to `r 
  final_merged2_df |> 
  filter(wheel_name == "Professor Trash Wheel") |> 
  summarize(total_weight = sum(weight_tons, na.rm = TRUE)) |> 
  pull(total_weight) 
` tons. Furthermore, the total number of cigarette butts collected by Gwynns in June of 2022 was `r 
  format (final_merged2_df |> 
  filter(wheel_name == "Gwynns Falls Trash Wheel", year == 2022, month == "June") |>
  summarize(total_butts = sum(cigarette_butts, na.rm = TRUE)) |>
  pull(total_butts), big.mark = ",", scientific = FALSE)` butts.
  
# Problem 3

1. First dataset

```{r message = FALSE}
zipcode_df = read_csv(file = "./zillow_data/Zip Codes.csv",,
        na = c(".", "NA", "")) |> 
  janitor::clean_names() |> 
  rename(county_name = county) |> 
  select(-county_fips) |> 
  relocate(zip_code, county_name) |> 
  arrange(zip_code)

zipcode_df
```

2. Second dataset

```{r message = FALSE}
rental_df = read_csv(file = "./zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv",,
        na = c(".", "NA", "")) |> 
  janitor::clean_names() |> 
  pivot_longer(
    x2015_1_31:x2024_8_31,
    names_to = "rental_date", 
    values_to = "rental_price") |> 
  mutate(
    county_name = stringr::str_replace(county_name, " County", ""),
    rental_date = stringr::str_replace(rental_date, "x", "")
  ) |> 
  separate(rental_date, into = c("year", "month", "day"), sep = "_") |> 
  mutate(
    month=as.integer(month),
    year=as.integer(year),
    day=as.integer(day)) |> 
  rename(zip_code = region_name) |> 
  relocate(zip_code, county_name) |> 
  select(-state, -region_type) |> 
  arrange(zip_code)

rental_df
```

3. Merge the data

```{r message = FALSE}
final_merged3_df = 
  rental_df |>
  left_join(zipcode_df, by = c("zip_code", "county_name"))

final_merged3_df
```

* The resulting dataset is a tidy, time-series data frame containing rental price metrics across various geographic levels. It appears to combine Zillow rental data (indicated by columns like zip_code, region_id, and rental_price) with geographic identifiers like county_name and state_name. Each row represents a rental price observation for a specific ZIP code and month. This dataset includes a total of `r nrow(final_merged3_df)` observations. Within these records, the data covers `r data.table::uniqueN(final_merged3_df$zip_code)` unique ZIP codes and `r final_merged3_df |>
  filter(!is.na(neighborhood)) |>
  # 2. Pull the clean column as a vector
  pull(neighborhood) |>
  data.table::uniqueN()` unique neighborhoods.

* `r anti_join(zipcode_df, rental_df, by = "zip_code") |> nrow()` ZIP codes appear in the ZIP code dataset but not in the Zillow Rental Price dataset. The reason is that many large office towers or institutions in major cities have their own dedicated ZIP codes. These areas have no street-level residential rentals for Zillow to track.

4. Make a table

```{r message = FALSE}
top_drop_zips <-
final_merged3_df |>
  # 1. Filter for the two target months/years
mutate(
    # Combine year, month, and day columns into a proper Date object
    # We use make_date() since the component columns already exist
    date_full = make_date(year,month, day)
  ) |>
  
  # 2. Filter for the entire continuous range
  filter(
    date_full >= as.Date("2020-01-31") & date_full <= as.Date("2021-12-31")
  ) |>
  
  # 2. Select columns needed for pivoting and identification
  select(zip_code, date_full, county_name, neighborhood, rental_price, -year, -month, -day) |>
  
  # 3. Pivot the data from long to wide format
  pivot_wider(
    id_cols = c(zip_code, county_name, neighborhood),
    names_from = date_full,
    values_from = rental_price,
    names_prefix = "Price_" # Creates columns named Price_2020 and Price_2021
  ) |>
  
  # 4. Calculate the price drop (2021 - 2020)
  mutate(
    price_drop_Jan = `Price_2021-01-31` - `Price_2020-01-31`,
    price_drop_Feb = `Price_2021-02-28` - `Price_2020-02-29`,
    price_drop_Mar = `Price_2021-03-31` - `Price_2020-03-31`,
    price_drop_Apr = `Price_2021-04-30` - `Price_2020-04-30`,
    price_drop_May = `Price_2021-05-31` - `Price_2020-05-31`,
    price_drop_Jun = `Price_2021-06-30` - `Price_2020-06-30`,
    price_drop_Jul = `Price_2021-07-31` - `Price_2020-07-31`,
    price_drop_Aug = `Price_2021-08-31` - `Price_2020-08-31`,
    price_drop_Sep = `Price_2021-09-30` - `Price_2020-09-30`,
    price_drop_Oct = `Price_2021-10-31` - `Price_2020-10-31`,
    price_drop_Nov = `Price_2021-11-30` - `Price_2020-11-30`,
    price_drop_Dec = `Price_2021-12-31` - `Price_2020-12-31`
  )
```

5. Compare Jan
```{r message = FALSE}
top_drop_Jan <-
top_drop_zips |> 
  arrange(price_drop_Jan) |> 
  select(
    zip_code,
    borough = county_name,
    neighborhood,
    price_drop_Jan
  ) |>
  head(10)

top_drop_Jan
```
* The list of the top 10 ZIP codes with the largest rental price drops between January 2020 and January 2021 is entirely comprised of areas within Manhattan (New York Borough), specifically neighborhoods in the Downtown and Midtown areas.

  * Magnitude of the Drop: The largest decrease was found in ZIP code 10007 (Lower Manhattan), with a staggering average drop of over 912 dollars per month. All top 10 ZIP codes saw average monthly rental price decreases of at least 684 dollars.

6. Options: Compare each month

```{r message = FALSE}

#2.
top_drop_Feb <-
top_drop_zips |> 
    arrange(price_drop_Feb) |> 
    select(
    zip_code,
    borough = county_name,
    neighborhood,
    price_drop_Feb
  ) |>
  head(10)

top_drop_Feb

#3.
top_drop_Mar <-
top_drop_zips |> 
    arrange(price_drop_Mar) |> 
    select(
    zip_code,
    borough = county_name,
    neighborhood,
    price_drop_Mar
  ) |>
  head(10)

top_drop_Mar

#4.
top_drop_Apr <-
top_drop_zips |> 
    arrange(price_drop_Apr) |> 
    select(
    zip_code,
    borough = county_name,
    neighborhood,
    price_drop_Apr
  ) |>
  head(10)

top_drop_Apr

#5. 
top_drop_May <-
top_drop_zips |> 
    arrange(price_drop_May) |> 
    select(
    zip_code,
    borough = county_name,
    neighborhood,
    price_drop_May
  ) |>
  head(10)

top_drop_May

#6.
top_drop_Jun <-
top_drop_zips |> 
    arrange(price_drop_Jun) |> 
    select(
    zip_code,
    borough = county_name,
    neighborhood,
    price_drop_Jun
  ) |>
  head(10)

top_drop_Jun

#7.
top_drop_Jul <-
top_drop_zips |>
    arrange(price_drop_Jul) |> 
    select(
    zip_code,
    borough = county_name,
    neighborhood,
    price_drop_Jul
  ) |>
  head(10)

top_drop_Jul

#8.
top_drop_Aug <-
top_drop_zips |> 
    arrange(price_drop_Aug) |> 
    select(
    zip_code,
    borough = county_name,
    neighborhood,
    price_drop_Aug
  ) |>
  head(10)

top_drop_Aug

#9.
top_drop_Sep <-
top_drop_zips |> 
    arrange(price_drop_Sep) |> 
    select(
    zip_code,
    borough = county_name,
    neighborhood,
    price_drop_Sep
  ) |>
  head(10)

top_drop_Sep

#10.
top_drop_Oct <-
top_drop_zips |> 
    arrange(price_drop_Oct) |> 
    select(
    zip_code,
    borough = county_name,
    neighborhood,
    price_drop_Oct
  ) |>
  head(10)

top_drop_Oct

#11.
top_drop_Nov <-
top_drop_zips |> 
    arrange(price_drop_Nov) |> 
    select(
    zip_code,
    borough = county_name,
    neighborhood,
    price_drop_Nov
  ) |>
  head(10)

top_drop_Nov

#12.
top_drop_Dec <-
top_drop_zips |>
    arrange(price_drop_Dec) |> 
    select(
    zip_code,
    borough = county_name,
    neighborhood,
    price_drop_Dec
  ) |>
  head(10)

top_drop_Dec

# The names here become the sheet names in Excel.
data_to_export <- list(
  "top_drop_Jan" = top_drop_Jan,
  "top_drop_Feb" = top_drop_Feb,
  "top_drop_Mar" = top_drop_Mar,
  "top_drop_Apr" = top_drop_Apr,
  "top_drop_May" = top_drop_May,
  "top_drop_Jun" = top_drop_Jun,
  "top_drop_Jul" = top_drop_Jul,
  "top_drop_Aug" = top_drop_Aug,
  "top_drop_Sep" = top_drop_Sep,
  "top_drop_Oct" = top_drop_Oct,
  "top_drop_Nov" = top_drop_Nov,
  "top_drop_Dec" = top_drop_Dec
)

# --- 3. Export the list to a single Excel file ---
writexl::write_xlsx(
  x = data_to_export, 
  path = "Price_month_Example.xlsx"
)
```

* The period from January 2020 to early 2021 saw the largest rental price declines concentrated in high-density Manhattan neighborhoods. However, as noted by the data showing positive price differences after August 2021, this trend quickly stabilized and shifted into a rebound. This recovery might be fueled by vaccine availability.
